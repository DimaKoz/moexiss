package moexiss

import (
	"github.com/buger/jsonparser"
	"testing"
)

func TestStatGetUrl(t *testing.T) {
	c := NewClient(nil)
	gotURL, err := c.Stats.getUrl(EngineStock, "shares", nil)
	if err != nil {
		t.Fatalf("Error: expecting <nil> error: \ngot %v \ninstead", err)
	}
	if got, expected := gotURL, `https://iss.moex.com/iss/engines/stock/markets/shares/secstats.json?iss.json=extended&iss.meta=off`; got != expected {
		t.Fatalf("Error: expecting url :\n`%s` \ngot \n`%s` \ninstead", expected, got)
	}
}

func TestStatGetUrlBadEngine(t *testing.T) {
	c := NewClient(nil)
	_, err := c.Stats.getUrl(EngineUndefined, "shares", nil)
	if got, expected := err, ErrBadEngineParameter; got != expected {
		t.Fatalf("Error: expecting %v error: \ngot %v \ninstead", expected, got)
	}
}

func TestStatGetUrlBadMarket(t *testing.T) {
	c := NewClient(nil)
	_, err := c.Stats.getUrl(EngineStock, "", nil)
	if got, expected := err, ErrBadMarketParameter; got != expected {
		t.Fatalf("Error: expecting %v error: \ngot %v \ninstead", expected, got)
	}
}

func TestParseSecStatItem(t *testing.T) {
	expectedStruct := SecStat{
		Ticker:           "GAZP",
		BoardId:          "TQBR",
		TrSession:        TradingSessionUndefined,
		Time:             "09:49:58",
		PriceMinusPrevPr: -22.98,
		VolToday:         47948300,
		ValToday:         12677905337,
		HighBid:          304.75,
		LowOffer:         250.92,
		LastOffer:        260.29,
		LastBid:          259.71,
		Open:             253.95,
		Low:              250.92,
		High:             273.99,
		Last:             260.29,
		LClosePrice:      0,
		NumTrades:        107517,
		WaPrice:          264.41,
		AdmittedQuote:    0,
		MarketPrice:      0,
		LCurrentPrice:    260.51,
		ClosingAucPrice:  0,
	}
	var incomeJSON = `
      {"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}
`
	secStatItem := SecStat{}
	err := parseSecStatItem([]byte(incomeJSON), &secStatItem)
	if err != nil {
		t.Fatalf("Error: expecting <nil> error: \ngot %v \ninstead", err)
	}
	if got, expected := secStatItem, expectedStruct; got != expected {
		t.Fatalf("Error: expecting: \n %v \ngot:\n %v \ninstead", expected, got)
	}
}

func TestParseSecStatItemErrCases(t *testing.T) {
	type Case struct {
		incomeJSON string
	}
	cases := []Case{
		// no SECID
		{`{"SECID1": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no BOARDID
		{`{"SECID": "GAZP", "BOARDID1": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no TRADINGSESSION
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION1": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no TIME
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME1": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no PRICEMINUSPREVWAPRICE
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE1": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no VOLTODAY
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY1": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no VALTODAY
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY1": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no HIGHBID
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID1": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no LOWOFFER
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER1": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no LASTOFFER
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER1": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no LASTBID
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID1": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no OPEN
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN1": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no LOW
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW1": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no HIGH
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH1": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no LAST
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST1": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no LCLOSEPRICE
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE1": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no NUMTRADES
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES1": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no WAPRICE
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE1": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no ADMITTEDQUOTE
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE1": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no MARKETPRICE2
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE21": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no LCURRENTPRICE
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE1": 260.51, "CLOSINGAUCTIONPRICE": null}`},
		// no CLOSINGAUCTIONPRICE
		{`{"SECID": "GAZP", "BOARDID": "TQBR", "TRADINGSESSION": "0", "TIME": "09:49:58", "PRICEMINUSPREVWAPRICE": -22.98, "VOLTODAY": 47948300, "VALTODAY": 12677905337, "HIGHBID": 304.75, "LOWOFFER": 250.92, "LASTOFFER": 260.29, "LASTBID": 259.71, "OPEN": 253.95, "LOW": 250.92, "HIGH": 273.99, "LAST": 260.29, "LCLOSEPRICE": null, "NUMTRADES": 107517, "WAPRICE": 264.41, "ADMITTEDQUOTE": null, "MARKETPRICE2": null, "LCURRENTPRICE": 260.51, "CLOSINGAUCTIONPRICE1": null}`},
	}

	for i, c := range cases {
		secStat := SecStat{}
		if got, expected := parseSecStatItem([]byte(c.incomeJSON), &secStat), jsonparser.KeyPathNotFoundError; got != expected {
			t.Fatalf("Error: expecting error: \n %v \ngot:\n %v \ninstead in %d case", expected, got, i)
		}
	}
}
